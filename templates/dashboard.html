{% extends "base.html" %}

{% block content %}
<div class="container my-5">
  <div class="card shadow">
    <div class="card-body text-center">
      <h3 class="card-title mb-4">Cyberbullying Risk Overview</h3>

      <!-- Pie Chart Container -->
      <div class="mx-auto" style="width: 80%; max-width: 500px; height: 300px;">
        <canvas id="riskPieChart"></canvas>
      </div>

      <!-- Minimal Summary -->
      <div class="mt-4">
        <div class="row">
          <div class="col-4">
            <h6 class="text-muted">Total</h6>
            <p class="fs-4">{{ comments|length }}</p>
          </div>
          <div class="col-4">
            <h6 class="text-danger">High Risk</h6>
            <p class="fs-4">{{ risk_counts.high }}</p>
          </div>
          <div class="col-4">
            <h6 class="text-success">Safe</h6>
            <p class="fs-4">{{ risk_counts.low }}</p>
          </div>
        </div>
      </div>

      <!-- Single Action Button -->
      <div class="mt-3">
        <a href="{{ url_for('analyze_file') }}" class="btn btn-primary">
          <i class="bi bi-file-earmark-arrow-up"></i> New Analysis
        </a>
      </div>
    </div>
  </div>
</div>

<!-- Load Chart.js from CDN -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<!-- Bootstrap Icons (optional) -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">

<script>
  document.addEventListener('DOMContentLoaded', function() {
    // Debug: Log the risk_counts to ensure data is received
    console.log("Risk counts data:", {{ risk_counts|tojson|safe }});

    const riskCounts = {{ risk_counts|tojson|safe }};
    const ctx = document.getElementById('riskPieChart');

    // Debug: Check if canvas element exists
    if (!ctx) {
      console.error("Canvas element not found!");
      return;
    }

    const context = ctx.getContext('2d');

    // Debug: Check if context is valid
    if (!context) {
      console.error("Could not get 2D context!");
      return;
    }

    new Chart(context, {
      type: 'pie',
      data: {
        labels: ['High Risk', 'Medium Risk', 'Low Risk'],
        datasets: [{
          data: [riskCounts.high, riskCounts.medium, riskCounts.low],
          backgroundColor: [
            '#ff6b6b',  // Red for high risk
            '#ffe66d',  // Yellow for medium risk
            '#51cf66'   // Green for low risk
          ],
          borderWidth: 0
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: {
            position: 'bottom',
          }
        }
      }
    });
  });
</script>
{% endblock %}
